# Frederica 企业微信聊天机器人 - 演示指南

## 快速开始

### 1. 环境准备
```bash
# 安装依赖
pip install -r requirements.txt

# 检查环境配置
python main.py --check
```

### 2. 配置企业微信
1. 登录企业微信管理后台
2. 进入"应用管理" -> "自建应用"
3. 创建或选择应用，获取以下信息：
   - 企业ID (WECHAT_WORK_CORPID)
   - 应用Secret (WECHAT_WORK_CORPSECRET)
   - 应用ID (WECHAT_WORK_AGENTID)
4. 将以上信息添加到 `.env` 文件

### 3. 启动机器人
```bash
# 启动企业微信聊天机器人
python main.py
```

### 4. 测试连接
```bash
# 发送测试消息（需要有效的用户ID）
python main.py --send-test <用户ID>
```

### 5. 开始对话
机器人启动后会自动连接企业微信：
- 用户发送文本消息到企业微信应用
- 机器人会智能回复
- 对话历史会自动保存到记忆库

## 功能演示

### 记忆系统演示
```bash
# 查看用户记忆摘要
python main.py --memory-summary <用户ID>

# 清除用户记忆
python main.py --clear-memory <用户ID>
```

### 状态检查
```bash
# 查看机器人状态
python main.py --status
```

## 测试对话示例

1. **普通问候**
   ```
   用户: 你好
   Frederica: 你好！我是Frederica，很高兴认识你！
   ```

2. **上下文记忆**
   ```
   用户: 我昨天说我喜欢吃披萨
   Frederica: 我记得你说过喜欢吃披萨！今天想聊聊披萨吗？
   ```

3. **沉默响应**
   ```
   用户: 好的
   Frederica: [保持沉默，不回复简单确认]
   ```

## 企业微信配置说明

### 消息接收方式
企业微信支持两种消息接收方式：

#### 方式一：回调模式（推荐用于生产环境）
1. 在应用详情页配置"接收消息"回调URL
2. 需要公网可访问的服务器
3. 配置Token、EncodingAESKey等参数

#### 方式二：主动拉取模式（适合本地测试）
1. 使用企业微信的"获取聊天记录"API
2. 定期轮询新消息
3. 当前实现使用此模式

### 应用权限配置
确保应用已配置以下权限：
- 接收消息权限
- 发送消息权限
- 通讯录读取权限（如需获取用户信息）

## 故障排除

### 企业微信连接失败
- 检查企业ID、应用Secret、应用ID是否正确
- 确认应用是否启用
- 检查网络是否可以访问企业微信API
- 确认应用有发送消息权限

### API调用失败
- 检查 `.env` 中的 `DEEPSEEK_API_KEY`
- 确认API密钥有足够余额
- 检查网络连接

### 消息发送失败
- 检查接收者用户ID是否正确
- 确认应用有发送消息权限
- 检查消息内容是否符合企业微信要求

## 高级功能

### 自定义系统提示
编辑 `src/llm.py` 中的系统消息：
```python
system_message = {
    "role": "system",
    "content": """你是一个名为Frederica的企业微信聊天机器人..."""
}
```

### 调整记忆策略
编辑 `src/memory.py`：
- 修改 `MAX_MEMORY_ITEMS` 控制记忆数量
- 调整 `MEMORY_RELEVANCE_THRESHOLD` 控制搜索精度

### 添加消息处理器
在 `src/wechat_bot.py` 中添加新的消息类型处理：
```python
def _process_incoming_message(self, msg_data: Dict[str, Any]):
    # 根据msg_type处理不同类型的消息
    msg_type = msg_data.get('MsgType', 'text')
    if msg_type == 'image':
        # 处理图片消息
    elif msg_type == 'voice':
        # 处理语音消息
```

## 安全注意事项

1. **保护API密钥和企业微信配置**：不要泄露 `.env` 文件
2. **遵守企业微信规则**：不要用于spam或违规用途
3. **数据隐私**：对话数据存储在本地SQLite数据库
4. **合理使用**：注意API调用频率和费用
5. **企业微信应用需要审核**：确保应用功能符合企业微信规范

## 架构说明

### 主要组件
1. **企业微信集成**：使用wechatpy库与企业微信API交互
2. **LLM引擎**：使用DeepSeek API进行智能对话
3. **记忆系统**：SQLite数据库存储对话历史
4. **异步处理**：多线程处理消息队列

### 消息流程
1. 轮询线程定期检查新消息
2. 收到消息后放入处理队列
3. 处理线程调用LLM生成回复
4. 回复放入发送队列
5. 发送线程将回复发送到企业微信

## 下一步改进

1. **实现回调模式**：支持公网服务器部署
2. **添加向量搜索**：提高记忆搜索准确性
3. **支持更多消息类型**：图片、语音、文件等
4. **添加管理命令**：/help, /clear, /status等
5. **实现用户管理**：基于企业微信通讯录的用户信息

---

**提示**：首次使用需要正确配置企业微信应用，请参考企业微信官方文档。
