# 企业微信IP白名单配置指南

## 问题描述
当运行 `python main.py --send-test <用户ID>` 时，出现以下错误：
```
发送测试消息失败: Error code: 60020, message: not allow to access from your ip, hint: [1768133857617340873544861], from ip: 112.96.49.30, more info at https://open.work.weixin.qq.com/devtool/query?e=60020
```

错误代码 `60020` 表示当前IP地址不在企业微信应用的可信IP列表中。

## 解决方案

### 方法一：配置企业微信IP白名单（推荐）

1. **登录企业微信管理后台**
   - 访问 https://work.weixin.qq.com/
   - 使用管理员账号登录

2. **进入应用管理**
   - 点击左侧菜单"应用管理"
   - 找到对应的自建应用（应用ID: 1000002）
   - 点击进入应用详情页

3. **配置可信IP**
   - 在应用详情页找到"企业可信IP"或"IP白名单"配置
   - 添加当前服务器的公网IP地址：
     - IPv4: `112.96.49.30`（根据错误信息）
     - IPv6: `2408:8459:c10:3136:55c3:9505:5af9:993f`
   - 保存配置

4. **等待生效**
   - 配置保存后可能需要几分钟生效
   - 重新运行测试命令

### 方法二：使用企业微信代理（如果需要）

如果无法将本地IP添加到白名单，可以考虑：

1. **使用云服务器**
   - 将机器人部署到云服务器（如阿里云、腾讯云）
   - 将云服务器的公网IP添加到白名单

2. **使用代理服务器**
   - 配置企业微信API通过代理访问
   - 修改 `src/wechat_bot.py` 中的客户端配置

### 方法三：本地开发替代方案

对于本地开发和测试，可以：

1. **使用企业微信测试环境**
   - 申请企业微信测试账号
   - 测试环境可能没有IP限制

2. **模拟消息处理**
   - 修改代码跳过实际消息发送
   - 只测试LLM和记忆系统功能

## 验证步骤

1. **检查当前IP**
   ```bash
   # 查看当前公网IP
   curl ifconfig.me
   curl ipv4.icanhazip.com
   ```

2. **测试连接**
   ```bash
   # 配置IP白名单后测试
   python main.py --send-test <用户ID>
   ```

3. **查看详细错误**
   - 访问错误提示中的链接查看详细错误信息
   - https://open.work.weixin.qq.com/devtool/query?e=60020

## 预防措施

1. **动态IP处理**
   - 如果使用家庭宽带或动态IP，考虑使用固定IP的云服务器
   - 或使用DDNS服务

2. **多环境配置**
   - 开发环境：使用测试企业微信账号
   - 生产环境：使用正式企业微信账号，配置固定IP

3. **监控和告警**
   - 监控企业微信API调用状态
   - 设置IP变更告警

## 相关文档

- [企业微信IP白名单配置](https://developer.work.weixin.qq.com/document/path/90665)
- [错误代码查询](https://open.work.weixin.qq.com/devtool/query)
- [API调用频率限制](https://developer.work.weixin.qq.com/document/path/90665#%E8%B0%83%E7%94%A8%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6)

## 注意事项

1. **安全考虑**
   - 不要将企业微信Secret泄露
   - 定期更换Secret
   - 限制IP白名单范围

2. **性能考虑**
   - IP白名单配置会影响API调用性能
   - 确保配置正确的IP地址

3. **合规要求**
   - 遵守企业微信使用规范
   - 确保应用功能符合企业微信审核要求
